/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package gui;

import entidades.Alumno;
import entidades.ModeloExamen;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import org.apache.poi.POIXMLException;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

/**
 *
 * @author UEE
 */
public final class CargarDatosExcel extends javax.swing.JDialog {

    private String nombreArchivo;
    private InputStream inp;
    private Workbook wb;
    private Sheet sheet;
    private Row row;
    private List<String> variables;
    private List<String> clavesRespuesta;  
    private List<String> temp;
    private List<Alumno> alumnos;
    private List<Alumno> alumnosOrdenada;
    private List<String> temp2;
    private List<String> opcionesRespuesta;   
    private List<ModeloExamen> modelosExamenes;    
    private Alumno alumno;
    private String variable_id;
    private String variable_modelo;
    private int indiceSujeto = 0;
    private int indiceModelo = 0;
    private int indice_inicio_items = 0;
    private int indice_fin_items = 0;    

    /**
     * Creates new form CargarDatosExcel
     */
    public CargarDatosExcel(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
    }

    /**
     * Creates new form CargarDatosExcel
     */
    public CargarDatosExcel(java.awt.Frame parent, String nombreArchivoExcel) {
        super(parent);
        this.setNombreArchivo(nombreArchivoExcel);

        if (this.pruebaArchivo()) {
            initComponents();
            this.leerNombresVariables();
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        boton_aceptar = new javax.swing.JButton();
        boton_cancelar = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        listaVariables = new javax.swing.JList();
        boton_cambiar_id_sujeto = new javax.swing.JButton();
        boton_cambiar_modelo_prueba = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        lista_variable_id_sujeto = new javax.swing.JList();
        jScrollPane3 = new javax.swing.JScrollPane();
        lista_variable_modelo_prueba = new javax.swing.JList();
        nombres_variables_primera_fila = new javax.swing.JCheckBox();
        clave_respuesta_segunda_fila = new javax.swing.JCheckBox();
        jLabel2 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Cargar datos desde Excel");
        setModal(true);
        setModalExclusionType(java.awt.Dialog.ModalExclusionType.APPLICATION_EXCLUDE);
        setResizable(false);

        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel1.setText(getNombreArchivo());
        jLabel1.setToolTipText("Nombre de archivo Excel");
        jLabel1.setCursor(new java.awt.Cursor(java.awt.Cursor.DEFAULT_CURSOR));
        jLabel1.setHorizontalTextPosition(javax.swing.SwingConstants.LEFT);

        jLabel3.setText("Identificador de sujeto:");

        boton_aceptar.setText("Aceptar");
        boton_aceptar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                boton_aceptarActionPerformed(evt);
            }
        });

        boton_cancelar.setText("Cancelar");
        boton_cancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                boton_cancelarActionPerformed(evt);
            }
        });

        jLabel4.setText("Modelo de prueba:");

        listaVariables.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        listaVariables.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                listaVariablesValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(listaVariables);

        boton_cambiar_id_sujeto.setText(">");
        boton_cambiar_id_sujeto.setEnabled(false);
        boton_cambiar_id_sujeto.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                boton_cambiar_id_sujetoActionPerformed(evt);
            }
        });

        boton_cambiar_modelo_prueba.setText(">");
        boton_cambiar_modelo_prueba.setEnabled(false);
        boton_cambiar_modelo_prueba.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                boton_cambiar_modelo_pruebaActionPerformed(evt);
            }
        });

        lista_variable_id_sujeto.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        lista_variable_id_sujeto.setAutoscrolls(false);
        lista_variable_id_sujeto.setVisibleRowCount(1);
        lista_variable_id_sujeto.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                lista_variable_id_sujetoValueChanged(evt);
            }
        });
        jScrollPane2.setViewportView(lista_variable_id_sujeto);

        lista_variable_modelo_prueba.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        lista_variable_modelo_prueba.setAutoscrolls(false);
        lista_variable_modelo_prueba.setVisibleRowCount(1);
        lista_variable_modelo_prueba.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                lista_variable_modelo_pruebaValueChanged(evt);
            }
        });
        jScrollPane3.setViewportView(lista_variable_modelo_prueba);

        nombres_variables_primera_fila.setSelected(true);
        nombres_variables_primera_fila.setText("Nombres de variables en la primer fila.");
        nombres_variables_primera_fila.setEnabled(false);

        clave_respuesta_segunda_fila.setSelected(true);
        clave_respuesta_segunda_fila.setText("Clave de respuesta en la segunda fila.");
        clave_respuesta_segunda_fila.setEnabled(false);

        jLabel2.setText("Nombres de variables:");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(104, 104, 104)
                .addComponent(boton_aceptar, javax.swing.GroupLayout.DEFAULT_SIZE, 76, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(boton_cancelar, javax.swing.GroupLayout.DEFAULT_SIZE, 80, Short.MAX_VALUE)
                .addGap(96, 96, 96))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGap(10, 10, 10))
            .addGroup(layout.createSequentialGroup()
                .addGap(10, 10, 10)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 128, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(boton_cambiar_modelo_prueba, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(boton_cambiar_id_sujeto, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jLabel3, javax.swing.GroupLayout.DEFAULT_SIZE, 140, Short.MAX_VALUE)
                            .addComponent(jLabel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 128, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 128, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addComponent(jLabel2)
                    .addComponent(nombres_variables_primera_fila)
                    .addComponent(clave_respuesta_segunda_fila))
                .addGap(10, 10, 10))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(nombres_variables_primera_fila)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(clave_respuesta_segunda_fila)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 12, Short.MAX_VALUE)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 142, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jLabel3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(boton_cambiar_id_sujeto))
                        .addGap(33, 33, 33)
                        .addComponent(jLabel4)
                        .addGap(4, 4, 4)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(boton_cambiar_modelo_prueba, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(jScrollPane3))
                        .addGap(16, 16, 16)))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(boton_aceptar)
                    .addComponent(boton_cancelar))
                .addContainerGap())
        );

        getAccessibleContext().setAccessibleParent(null);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void boton_cancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_boton_cancelarActionPerformed
        this.dispose();
    }//GEN-LAST:event_boton_cancelarActionPerformed

    private void listaVariablesValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_listaVariablesValueChanged
        this.lista_variable_id_sujeto.clearSelection();
        this.lista_variable_modelo_prueba.clearSelection();

        if (this.listaVariables.getSelectedIndex() >= 0) {
            if (this.lista_variable_id_sujeto.getModel().getSize() == 0) {
                this.boton_cambiar_id_sujeto.setText(">");
                this.boton_cambiar_id_sujeto.setEnabled(true);
            } else {
                this.boton_cambiar_id_sujeto.setEnabled(false);
            }

            if (this.lista_variable_modelo_prueba.getModel().getSize() == 0) {
                this.boton_cambiar_modelo_prueba.setText(">");
                this.boton_cambiar_modelo_prueba.setEnabled(true);
            } else {
                this.boton_cambiar_modelo_prueba.setEnabled(false);
            }
        } else {
            this.boton_cambiar_id_sujeto.setEnabled(false);
            this.boton_cambiar_modelo_prueba.setEnabled(false);
        }

    }//GEN-LAST:event_listaVariablesValueChanged

    private void boton_cambiar_id_sujetoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_boton_cambiar_id_sujetoActionPerformed
        temp = new ArrayList<>();                               

        if (this.boton_cambiar_id_sujeto.getText().equalsIgnoreCase(">")) {
            //Agregamos la variable a 
            temp.add(this.listaVariables.getModel().getElementAt(this.listaVariables.getSelectedIndex()).toString());
            this.lista_variable_id_sujeto.setListData(temp.toArray());

            //Cambiamos el modelo de datos
            indiceSujeto = this.listaVariables.getSelectedIndex();
            temp2.remove(this.listaVariables.getSelectedIndex());
            this.listaVariables.setListData(temp2.toArray());
        } else {
            if (this.boton_cambiar_id_sujeto.getText().equalsIgnoreCase("<")) {                
                temp2.add(indiceSujeto, this.lista_variable_id_sujeto.getModel().getElementAt(this.lista_variable_id_sujeto.getSelectedIndex()).toString());
                this.listaVariables.setListData(temp2.toArray());

                this.lista_variable_id_sujeto.setListData(temp.toArray());
            }
        }

    }//GEN-LAST:event_boton_cambiar_id_sujetoActionPerformed

    private void boton_cambiar_modelo_pruebaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_boton_cambiar_modelo_pruebaActionPerformed
        temp = new ArrayList<>();

        if (this.boton_cambiar_modelo_prueba.getText().equalsIgnoreCase(">")) {
            //Agregamos la variable a 
            temp.add(this.listaVariables.getModel().getElementAt(this.listaVariables.getSelectedIndex()).toString());
            this.lista_variable_modelo_prueba.setListData(temp.toArray());

            //Cambiamos el modelo de datos
            indiceModelo = this.listaVariables.getSelectedIndex();
            this.temp2.remove(this.listaVariables.getSelectedIndex());
            this.listaVariables.setListData(this.temp2.toArray());
        } else {
            if (this.boton_cambiar_modelo_prueba.getText().equalsIgnoreCase("<")) {
                this.temp2.add(indiceModelo, this.lista_variable_modelo_prueba.getModel().getElementAt(this.lista_variable_modelo_prueba.getSelectedIndex()).toString());
                this.listaVariables.setListData(this.temp2.toArray());

                this.lista_variable_modelo_prueba.setListData(temp.toArray());
            }
        }

    }//GEN-LAST:event_boton_cambiar_modelo_pruebaActionPerformed

    private void boton_aceptarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_boton_aceptarActionPerformed
        try {
            this.variable_id = this.lista_variable_id_sujeto.getModel().getElementAt(0).toString();                
            this.variable_modelo = this.lista_variable_modelo_prueba.getModel().getElementAt(0).toString();                

            leeClaveRespuestas();
            calculaNumeroItems();
            leeDatos();
            calculaNumeroExaminados();
            ordenaDatos();
            calculaRango();                                               

            this.dispose();                        
        
            for(int j=0; j<this.modelosExamenes.size(); j++) { 
                
                this.modelosExamenes.get(j).setVarIdSujeto(this.variable_id);
                this.modelosExamenes.get(j).setVars_contexto(this.modelosExamenes.get(j).getVariables().subList(0, (this.modelosExamenes.get(j).getIndice_inicio_items()-1)));
                this.modelosExamenes.get(j).setVars_items( this.modelosExamenes.get(j).getVariables().subList(this.modelosExamenes.get(j).getIndice_inicio_items(), this.modelosExamenes.get(j).getIndice_fin_items()) );
                
                System.out.println("Opciones de respuesta: " + this.modelosExamenes.get(j).getNombreModelo());
                
                for (int i = 0; i < this.modelosExamenes.get(j).getOpcionesRespuesta().size(); i++) {
                    System.out.print(this.modelosExamenes.get(j).getOpcionesRespuesta().get(i) + ", ");
                }
                
                System.out.println("");
                
                System.out.println("Alumnos Ordenada: " + this.modelosExamenes.get(j).getNombreModelo());
                
                for (int i = 0; i < this.modelosExamenes.get(j).getAlumnosOrdenada().size(); i++) {
                    System.out.print(this.modelosExamenes.get(j).getAlumnosOrdenada().get(i).getAciertos() + ", ");
                }
                
                System.out.println("");
            }                       
            
            JOptionPane.showMessageDialog(this, "Base de datos cargada.", "Mensaje", JOptionPane.INFORMATION_MESSAGE);
            this.inp.close();
        } catch (IOException ex) {
            Logger.getLogger(CargarDatosExcel.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_boton_aceptarActionPerformed

    private void lista_variable_id_sujetoValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_lista_variable_id_sujetoValueChanged
        //Quitamos los elementos seleccionados de los otros list
        this.listaVariables.clearSelection();
        this.lista_variable_modelo_prueba.clearSelection();

        if (this.lista_variable_id_sujeto.getSelectedIndex() >= 0) {
            //Cambiamos el sentido del botón y lo habilitamos
            this.boton_cambiar_id_sujeto.setText("<");
            this.boton_cambiar_id_sujeto.setEnabled(true);
        } else {
            this.boton_cambiar_id_sujeto.setEnabled(false);
        }

    }//GEN-LAST:event_lista_variable_id_sujetoValueChanged

    private void lista_variable_modelo_pruebaValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_lista_variable_modelo_pruebaValueChanged
        //Quitamos los elementos seleccionados de los otros list
        this.listaVariables.clearSelection();
        this.lista_variable_id_sujeto.clearSelection();

        if (this.lista_variable_modelo_prueba.getSelectedIndex() >= 0) {
            //Cambiamos el sentido del botón y lo habilitamos
            this.boton_cambiar_modelo_prueba.setText("<");
            this.boton_cambiar_modelo_prueba.setEnabled(true);
        } else {
            this.boton_cambiar_modelo_prueba.setEnabled(false);
        }
    }//GEN-LAST:event_lista_variable_modelo_pruebaValueChanged

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException | InstantiationException | IllegalAccessException | javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(CargarDatosExcel.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                CargarDatosExcel dialog = new CargarDatosExcel(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton boton_aceptar;
    private javax.swing.JButton boton_cambiar_id_sujeto;
    private javax.swing.JButton boton_cambiar_modelo_prueba;
    private javax.swing.JButton boton_cancelar;
    private javax.swing.JCheckBox clave_respuesta_segunda_fila;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JList listaVariables;
    private javax.swing.JList lista_variable_id_sujeto;
    private javax.swing.JList lista_variable_modelo_prueba;
    private javax.swing.JCheckBox nombres_variables_primera_fila;
    // End of variables declaration//GEN-END:variables

    private void leerNombresVariables() {
        modelosExamenes = new ArrayList<>();
        
        for(int i=0; i<wb.getNumberOfSheets(); i++) {
            ModeloExamen modeloExamen = new ModeloExamen();
            
            variables = new ArrayList<>();

            sheet = wb.getSheetAt(i);
            modeloExamen.setNombreModelo(sheet.getSheetName());

            row = sheet.getRow(0);

            for (Cell cell : row) {
                try {
                    switch (cell.getCellType()) {
                        case Cell.CELL_TYPE_STRING:
                            System.out.println(cell.getRichStringCellValue().getString());
                            variables.add(cell.getRichStringCellValue().getString());
                            break;
                        case Cell.CELL_TYPE_NUMERIC:
                            System.out.println(Double.toString(cell.getNumericCellValue()));
                            variables.add(Integer.toString((int) cell.getNumericCellValue()));
                            break;
                    }
                } catch (IllegalStateException ex) {
                    Logger.getLogger(CargarDatosExcel.class.getName()).log(Level.SEVERE, null, ex);
                    JOptionPane.showMessageDialog(this, "Error al leer los nombres de las variables.", "Error", JOptionPane.ERROR_MESSAGE);
                }

            }

            this.listaVariables.setListData(variables.toArray());
            temp2 = new ArrayList<>(this.variables.subList(0, variables.size()));
            
            modeloExamen.setVariables(variables);
            
            this.modelosExamenes.add(modeloExamen);
        }
                        
    }

    private boolean pruebaArchivo() {
        try {
            inp = new FileInputStream(nombreArchivo);

            String ext = nombreArchivo.substring(nombreArchivo.length() - 3);

            if (ext.equalsIgnoreCase("xls")) {
                wb = new HSSFWorkbook(inp);
            } else {
                if (ext.equalsIgnoreCase("lsx")) {
                    wb = new XSSFWorkbook(inp);
                }
            }            

            return true;

        } catch (IOException | POIXMLException ex) {
            Logger.getLogger(CargarDatosExcel.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(this, "Error al abrir el archivo.", "Error", JOptionPane.ERROR_MESSAGE);

            return false;
        }

    }

    private void leeClaveRespuestas() {
        
        for(int j=0; j<this.modelosExamenes.size(); j++) {
            clavesRespuesta = new ArrayList<>();
            
            sheet = wb.getSheetAt(j);            
            row = sheet.getRow(1);
            
            int i = 0;

            for (Cell cell : row) {
                i++;

                try {                
                    if(i==1) {
                        this.indice_inicio_items = cell.getColumnIndex();
                        //System.out.println("indice_inicio_items: " + indice_inicio_items);
                    }

                    switch (cell.getCellType()) {
                        case Cell.CELL_TYPE_STRING:

                            if (!cell.getRichStringCellValue().getString().isEmpty()) {
                                //System.out.println(i + " " + cell.getRichStringCellValue().getString());
                                clavesRespuesta.add(cell.getRichStringCellValue().getString());
                            } else {
                                System.out.println("VACIO S");
                            }

                            break;
                        case Cell.CELL_TYPE_NUMERIC:
                            if (cell.getNumericCellValue() != 0) {
                                //System.out.println(i + " " + Double.toString(cell.getNumericCellValue()));
                                clavesRespuesta.add(Double.toString(cell.getNumericCellValue()));
                            } else {
                                System.out.println("VACIO N");
                            }

                            break;
                    }

                } catch (IllegalStateException ex) {
                    Logger.getLogger(CargarDatosExcel.class.getName()).log(Level.SEVERE, null, ex);
                    JOptionPane.showMessageDialog(this, "Error al leer los nombres de las variables.", "Error", JOptionPane.ERROR_MESSAGE);
                }

            }

            indice_fin_items = indice_inicio_items + (i-1);
            //System.out.println("indice_fin_items: " + indice_fin_items);
                        
            this.modelosExamenes.get(j).setIndice_inicio_items(indice_inicio_items);
            this.modelosExamenes.get(j).setIndice_fin_items(indice_fin_items);
            this.modelosExamenes.get(j).setClavesRespuesta(clavesRespuesta);
        }
        
        
    }
    
    private void calculaNumeroItems() {
        for (int i = 0; i < this.modelosExamenes.size(); i++) {
            int numero_de_items = (this.modelosExamenes.get(i).getIndice_fin_items() - this.modelosExamenes.get(i).getIndice_inicio_items()) + 1;

            this.modelosExamenes.get(i).setNumero_de_items(numero_de_items);
        }
    }

    private void leeDatos() {
        
        for(int j=0; j<this.modelosExamenes.size(); j++) {
            sheet = wb.getSheetAt(j);
            
            alumnos = new ArrayList<>();
            opcionesRespuesta = new ArrayList<>();
            int contRenglones = 0;

            System.out.println("Variables size: " + this.modelosExamenes.get(j).getVariables().size());

            for (Row row_temp : sheet) {
                contRenglones++;

                try {
                    //Omitimos los dos primeros renglones (nombres_variables y clave_respuesta)
                    if(contRenglones>2) {
                        alumno = new Alumno(this.modelosExamenes.get(j).getClavesRespuesta().size());
                        int i = 0;

                        for (Cell cell : row_temp) {
                            boolean flag = true;

                            //System.out.println("Columna: " + this.variables.get(cell.getColumnIndex()));

                            if( this.modelosExamenes.get(j).getVariables().get(cell.getColumnIndex()).equalsIgnoreCase(this.variable_id) ) {                            
                                alumno.setId(getValorCeldaEnString(cell));                            
                                flag = false;
                            }                        
                            
                            alumno.setModelo(sheet.getSheetName());                            
                            alumno.addRespuesta(getValorCeldaEnString(cell)); 

                            if( (cell.getColumnIndex() >= this.modelosExamenes.get(j).getIndice_inicio_items()) && (cell.getColumnIndex() <= this.modelosExamenes.get(j).getIndice_fin_items()) ) {
                                agregaOpcionRespuesta(getValorCeldaEnString(cell));

                                if(this.modelosExamenes.get(j).getClavesRespuesta().get(i).equalsIgnoreCase(alumno.getRespuesta(i+this.modelosExamenes.get(j).getIndice_inicio_items()))) {
                                    alumno.addRespuestaCalificada(1, i);
                                } else {
                                    alumno.addRespuestaCalificada(0, i);
                                }

                                i++;
                            }

                        }

                        alumno.setAciertos(califica(alumno, j));
                        alumnos.add(alumno);                    
                    }                

                } catch (IllegalStateException ex) {
                    Logger.getLogger(CargarDatosExcel.class.getName()).log(Level.SEVERE, null, ex);
                    JOptionPane.showMessageDialog(this, "Error al leer los nombres de las variables.", "Error", JOptionPane.ERROR_MESSAGE);
                }

            }
            
            this.modelosExamenes.get(j).setAlumnos(alumnos);
            this.modelosExamenes.get(j).setOpcionesRespuesta(opcionesRespuesta);            
        }
                
    }
    
    private void calculaNumeroExaminados() {
        for (int i = 0; i < this.modelosExamenes.size(); i++) {
            int numero_de_examinados = this.modelosExamenes.get(i).getAlumnos().size();

            this.modelosExamenes.get(i).setNumero_de_examinados(numero_de_examinados);
        }
    } 

    private String getValorCeldaEnString(Cell celda) {
        String valor = "";
        
        switch (celda.getCellType()) {                                                        
            case Cell.CELL_TYPE_STRING:

                if (!celda.getRichStringCellValue().getString().isEmpty()) {                                    
                    //System.out.println(celda.getRichStringCellValue().getString());
                    valor = celda.getRichStringCellValue().getString();                    
                } else {
                    //System.out.println(celda.getRichStringCellValue().getString());
                    valor = ".";
                }

                break;
            case Cell.CELL_TYPE_NUMERIC:
                if (celda.getNumericCellValue() != 0) {
                    //System.out.println(Double.toString(celda.getNumericCellValue()));
                    valor = Double.toString(celda.getNumericCellValue());
                } else {
                    //System.out.println("");
                    valor = ".";
                }

                break;
        }
        
        return valor;
    }

    //Evalua las respuestas del alumno y regresa el número de aciertos obtenidos
    public int califica(Alumno a, int j) {
        int aciertos = 0;

        for (int i = 0; i < this.modelosExamenes.get(j).getClavesRespuesta().size(); i++) {            
            aciertos += a.getRespuestaCalificada(i);                        
        }

        //System.out.println(a.getId() + ".- Aciertos: " + aciertos);
        return aciertos;
    }

    private void ordenaDatos() {
        for(int k=0; k<this.modelosExamenes.size(); k++) {
            alumnosOrdenada = new ArrayList<>();
            int j = 0, i;

            for (Alumno a : this.modelosExamenes.get(k).getAlumnos()) {
                j++;
                //System.out.print(j + " ");
                if (alumnosOrdenada.isEmpty()) {
                    //System.out.println("Alumno0: " + a.getId());
                    alumnosOrdenada.add(a);
                } else {
                    for (i = 0; i < alumnosOrdenada.size(); i++) {
                        if (a.getAciertos() > alumnosOrdenada.get(i).getAciertos()) {
                            //System.out.println("Alumno2: " + a.getId());
                            alumnosOrdenada.add(i, a);
                            break;
                        }
                    }

                    if (i == alumnosOrdenada.size()) {
                        //System.out.println("Alumno1: " + a.getId());
                        alumnosOrdenada.add(a);
                    }

                }

                //System.out.println(alumnosOrdenada.size());
            }
            
            this.modelosExamenes.get(k).setAlumnosOrdenada(alumnosOrdenada);
        }        
    }

    private void calculaRango() {
        for (int i = 0; i < this.modelosExamenes.size(); i++) {
            int rango_minimo = this.modelosExamenes.get(i).getAlumnosOrdenada().get(this.modelosExamenes.get(i).getAlumnosOrdenada().size() - 1).getAciertos();
            int rango_maximo = this.modelosExamenes.get(i).getAlumnosOrdenada().get(0).getAciertos();

            this.modelosExamenes.get(i).setRango_minimo(rango_minimo);
            this.modelosExamenes.get(i).setRango_maximo(rango_maximo);
        }
    }
    
    private void agregaOpcionRespuesta(String valorCeldaEnString) {
        if(!opcionesRespuesta.contains(valorCeldaEnString)) {
            opcionesRespuesta.add(valorCeldaEnString);            
        }
    }        
    
    public void pintaLista(List lista, String titulo) {
        System.out.println(titulo);
        
        for (int i = 0; i < lista.size(); i++) {
            System.out.print(lista.get(i) + ", ");
        }
        
    }
    
    public List<String> getVariables() {
        return this.variables;
    }

    public List<String> getClavesRespuesta() {
        return this.clavesRespuesta;
    }
    
    public List<String> getOpcionesRespuesta() {
        return opcionesRespuesta;
    }

    public List<Alumno> getAlumnos() {
        return this.alumnos;
    }
    
    public List<Alumno> getAlumnosOrdenada() {
        return this.alumnosOrdenada;
    }

    public int getIndice_inicio_items() {
        return this.indice_inicio_items;
    }
    
    public int getIndice_fin_items() {
        return (this.indice_fin_items+1);
    }       

    public String getNombreArchivo() {
        return nombreArchivo;
    }

    public void setNombreArchivo(String nombreArchivo) {
        this.nombreArchivo = nombreArchivo;
    }
    
    public List<ModeloExamen> getModelosExamenes() {
        return modelosExamenes;
    }

    
}
